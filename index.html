<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .countries {
        fill: none;
        stroke: rgb(0, 0, 0);
        stroke-linejoin: round;
        stroke-width: 1px;
    }

    .boundary {
        fill: #DEB887;
        stroke: black;
        stroke-width: 1px;
    }

    .legendThreshold {
        font-size: 12px;
        font-family: sans-serif;
    }

    .caption {
        fill: #000;
        text-anchor: start;
        font-weight: bold;
    }

    .selected {
        fill: rgb(0, 13, 255);
    }

    .hidden {
        display: none;
    }

    .globe {
        fill: #EEE;
        stroke: #000;
        stroke-width: 0.2;
        r: initialScale
    }

    div.tooltip {
        color: #222;
        background: #fff;
        border-radius: 3px;
        box-shadow: 0px 0px 2px 0px #a6a6a6;
        padding: .2em;
        text-shadow: #f5f5f5 0 1px 0;
        opacity: 0.9;
        position: absolute;
    }
    
    .slidecontainer {
      width: 100%; /* Width of the outside container */
    }

    /* The slider itself */
    .slider {
      -webkit-appearance: none;  /* Override default CSS styles */
      appearance: none;
      width: 30%; /* Full-width */
      height: 25px; /* Specified height */
      background: #d3d3d3; /* Grey background */
      outline: none; /* Remove outline */
      opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
      -webkit-transition: .2s; /* 0.2 seconds transition on hover */
      transition: opacity .2s;
    }

    /* Mouse-over effects */
    .slider:hover {
      opacity: 1; /* Fully shown on mouse-over */
    }

    /* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none; /* Override default look */
      appearance: none;
      width: 25px; /* Set a specific slider handle width */
      height: 25px; /* Slider handle height */
      background: #0407aa; /* Green background */
      cursor: pointer; /* Cursor on hover */
    }

    .slider::-moz-range-thumb {
      width: 25px; /* Set a specific slider handle width */
      height: 25px; /* Slider handle height */
      background: #04AA6D; /* Green background */
      cursor: pointer; /* Cursor on hover */
    }
</style>
<div id="map"></div>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>
    // Variable Definitions
    var usa, canada; // countries which have states need to be tracked individually
    var states; // track states
    var countries; // track countries
    var initX; //track where mouse was clicked
    var s = 1; //track scale only rotate when s === 1
    var mouseClicked = false;
    var queue = d3.queue();
    var rotated = 90;

    // The svg
    var svg = d3.select("svg"),

        width = +svg.attr("width"),
        height = +svg.attr("height");

    svg.attr("height", height)
        //track where user clicked down
        .on("mousedown", function () {
            d3.event.preventDefault();
            //only if scale === 1
            if (s !== 1) return;
            initX = d3.mouse(this)[0];
            mouseClicked = true;
            console.log("clicked");
        })
        .on("mouseup", function () {
            if (s !== 1) return;
            rotated = rotated + ((d3.mouse(this)[0] - initX) * 360 / (s * width));
            mouseClicked = false;
        });

    // Map and projection
    var path = d3.geoPath();
    let projection = d3.geoOrthographic()
        .scale(250)
        .center([0, 0])
        .rotate([0, -30])
        .translate([width / 2, height / 2])

    var zoom = d3.zoom()
        .scaleExtent([1, 20])
        .on("zoom", zoomed);

    const initialScale = projection.scale()
    var path = d3.geoPath()
        .projection(projection);

    // Data and color scale
    var data = d3.map();
    var colorScheme = d3.schemeReds[6];
    colorScheme.unshift("#eee")
    var colorScale = d3.scaleThreshold()
        .domain([1, 6, 11, 26, 101, 1001])
        .range(colorScheme);

    // Legend
    var g = svg.append("g")
        .attr("class", "legendThreshold")
        .attr("transform", "translate(20,20)");
    g.append("text")
        .attr("class", "caption")
        .attr("x", 0)
        .attr("y", -6)
        .text("Number of Cases");
    var labels = ['0', '1-5', '6-10', '11-25', '26-100', '101-1000', '> 1000'];
    var legend = d3.legendColor()
        .labels(function (d) { return labels[d.i]; })
        .shapePadding(4)
        .scale(colorScale);
    svg.select(".legendThreshold")
        .call(legend);

    // Load external data and boot
    queue
        .defer(d3.json, "http://enjalot.github.io/wwsd/data/world/world-110m.geojson")
        .defer(d3.csv, "mooc-countries.csv", function (d) { data.set(d.code, +d.total); })
        .await(ready);


    let globe = svg.append("circle")
        .attr("fill", "#EEE")
        .attr("stroke", "#000")
        .attr("stroke-width", "2.4")
        .attr("cx", width / 2)
        .attr("cy", height / 2)
        .attr("r", initialScale)

    // Versor dragging and zooming
    const sensitivity = 75
    svg.call(d3.drag().on('drag', () => {
        const rotate = projection.rotate()
        const k = sensitivity / projection.scale()
        projection.rotate([
            rotate[0] + d3.event.dx * k,
            rotate[1] - d3.event.dy * k
        ])
        path = d3.geoPath().projection(projection)
        svg.selectAll("path").attr("d", path)
    }))
        // Zooming functionality
        .call(d3.zoom()
        .scaleExtent([1,20])
        .on("zoom", zoomed));

    // Function called when clicking on an individual country
    function selected() {
        d3.select('.selected').classed('selected', false);
        d3.select(this).classed('selected', true);
        console.log("selected a country");
    }

    // Tooltip stuff
    var offsetL = document.getElementById('map').offsetLeft + 10;
    var offsetT = document.getElementById('map').offsetTop + 10;

    function showTooltip(d) {
        label = d.properties.name;
        var mouse = d3.mouse(svg.node())
            .map(function (d) { return parseInt(d); });
        tooltip.classed("hidden", false)
            .attr("style", "left:" + (mouse[0] + offsetL) + "px;top:" + (mouse[1] + offsetT) + "px")
            .html(label);
    }

    var tooltip = d3.select("#map")
        .append("div")
        .attr("class", "tooltip hidden");

    //need this for correct panning
    var g = svg.append("g");

    // Finalizing & Execution. Get JSON data and draw map
    // This is honest an abominable combination of two functions, but whatever.
    function ready(error, topo) {
        d3.json("combined2.json", function (error, world) {
            if (error) return console.error(error);
            // Draw the map
            svg.append("g")
                // Countries
                .attr("class", "countries")
                .selectAll("path")
                .data(topo.features)
                .enter().append("path")
                .attr("fill", function (d) {
                    // Pull data for this country
                    d.total = data.get(d.id) || 0;
                    // Set the color
                    return colorScale(d.total);
                })
                .attr("name", function (d) { return d.properties.name; })
                .attr("id", function (d) { return d.id; })
                .on('click', selected) // when clicking country, call `selected` function
                .on("mousemove", showTooltip)
                .on("mouseout", function (d, i) {
                    tooltip.classed("hidden", true);
                })
                .attr("d", path);

            countries = d3.selectAll('.country');
            usa = d3.select('#USA');
            canada = d3.select('#CAN');

            svg.append("g")

            //states
            g.append("g")
                .attr("class", "boundary state hidden")
                .selectAll("boundary")
                .data(topojson.feature(world, world.objects.states).features)
                .enter().append("path")
                .attr("name", function (d) { return d.properties.name; })
                .attr("id", function (d) { return d.id; })
                .on('click', selected)
                .on("mousemove", showTooltip)
                .on("mouseout", function (d, i) {
                    tooltip.classed("hidden", true);
                })
                .attr("d", path);

            states = d3.selectAll('.state');
        })
        console.log("ready() finished.")
    }
    
    // Called when zooming in/out
    function zoomed() {
        console.log("zoomed() called");
        // d3.event.transform.k = current level of zoom
        s = d3.event.transform.k;
        if (d3.event.transform.k > 0.3) {
            projection.scale(initialScale * d3.event.transform.k)
            path = d3.geoPath().projection(projection)
            svg.selectAll("path").attr("d", path)
            globe.attr("r", projection.scale())
        }
        else {
            d3.event.transform.k = 0.3
        }

        //adjust the stroke width based on zoom level
        d3.selectAll(".boundary")
            .style("stroke-width", 6 / s);

        //toggle state/USA visability
        if (s > 3.5) {
            states
                .classed('hidden', false);
            usa
                .classed('hidden', true);
            canada
                .classed('hidden', true);
        } else {
            states
                .classed('hidden', true);
            usa
                .classed('hidden', false);
            canada
                .classed('hidden', false);
        }
    }
    
    // Activates when button is pressed
    function test(){
        console.log("activated");
        d3.csv, "mooc-countries.csv", function (d) { data.set(d.code, +d.total);
        d3.csv("test_transition.csv", function (d) { data.set(d.code, +d.total)});

        d3.select('#RUS').select('path').style("fill", function(d) {
             var value = d.properties.value;

             if (value) {
                 return color(value);
             } else {
                 return "#ccc";
             }
        });
        //svg.select('#RUS')
        /*
        svg.selectAll("path").filter(function(d) {
            return d.properties.id == "RUS";
        }).style("fill", function(d) {
             var value = d.properties.value;

             if (value) {
                 return color(value);
             } else {
                 return "#ccc";
             }
        });
       }
       */
       d3.select('#USA');
    }
}

</script>
<div class="slidecontainer">
  <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
</div>

<script>
var slider = document.getElementById("myRange");
var output = document.getElementById("demo");

slider.oninput = function() {
  console.log(this.value);
}
</script>
<button onclick="test()">Click Me!</button> 